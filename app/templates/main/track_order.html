{% extends 'base.html' %}

{% block title %}Lacak Pesanan Anda - PetShopin{% endblock %}

{% block page_title %}Lacak Status Pesanan Anda{% endblock %}

{% block head_extra %}
<style>
    .track-order-page .card {
        margin-bottom: 1.5rem;
        border: 1px solid #e9ecef;
        box-shadow: 0 .1rem .3rem rgba(0,0,0,.075)!important;
    }
    .track-order-page .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        font-weight: 500;
    }
    .track-order-page .form-label {
        font-weight: 500;
        font-size: 0.9rem;
    }
    .track-order-page .btn-primary {
        background-color: var(--petshop-green-primary);
        border-color: var(--petshop-green-primary);
        color: white;
        font-weight: 500;
    }
    .track-order-page .btn-primary:hover {
        background-color: var(--petshop-green-darker);
        border-color: var(--petshop-green-darker);
    }
    .tracking-history-list {
        padding-left: 0;
        list-style-type: none;
        font-size: 0.875rem;
    }
    .tracking-history-list li {
        padding: 0.8rem 0.6rem;
        border-bottom: 1px dashed #e9ecef;
        position: relative;
        padding-left: 28px;
    }
    .tracking-history-list li:last-child { border-bottom: none; }
    .tracking-history-list li::before {
        content: '\f111'; font-family: FontAwesome; position: absolute;
        left: 5px; top: 15px; font-size: 0.6rem; color: var(--petshop-green-primary);
    }
    .tracking-history-list strong { display: block; color: #343a40; font-weight: 500; }
    .tracking-history-list small.location { color: #6c757d; display: block; margin-top: 2px; }
</style>
{% endblock %}

{% block content %}
<div class="container track-order-page py-4">
    {% include '_messages.html' %}

    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fa fa-search me-2" style="color: var(--petshop-green-primary);"></i>Masukkan Detail Pelacakan</h5>
                </div>
                <div class="card-body p-4">
                    <form method="POST" action="{{ url_for('main.track_order_page') }}" id="trackingForm">
                        <div class="mb-3">
                            <label for="invoice_number_input" class="form-label">Nomor Invoice / Order ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="invoice_number_input" name="invoice_number_input" value="{{ invoice_query or '' }}" placeholder="Contoh: INV-20240101-XXXX" required>
                        </div>
                        <div class="mb-3">
                            <label for="airway_bill_input" class="form-label">Nomor Resi (AWB) <span class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="airway_bill_input" name="airway_bill_input" value="{{ awb_query or '' }}" placeholder="Masukkan nomor resi dari ekspedisi" required>
                        </div>
                        <div class="mb-3" id="courier_selection_div">
                            <label for="courier_code" class="form-label">Pilih Kurir Ekspedisi <span class="text-danger">*</span></label>
                            <select class="form-select form-select-sm" id="courier_code" name="courier_code" required>
                                <option value="">-- Pilih Kurir --</option>
                                {% for code, name in supported_couriers.items() %}
                                    <option value="{{ code }}" {% if courier_query == code %}selected{% endif %}>{{ name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fa fa-search"></i> Lacak Sekarang
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            {# Hasil Pelacakan Internal #}
            {% if internal_order_status %}
            <div class="card shadow-sm mt-4">
                <div class="card-header {% if tracking_result and internal_order_status.awb_from_db %}bg-light{% else %}bg-info text-white{% endif %} py-3">
                    <h5 class="mb-0">Status Pesanan Internal: {{ internal_order_status.invoice_number }}</h5>
                </div>
                <div class="card-body p-4">
                    <p><strong>Nama Pemesan:</strong> {{ internal_order_status.customer_name }}</p>
                    <p><strong>Status Pesanan:</strong> <span class="fw-bold">{{ internal_order_status.status }}</span></p>
                    <p><strong>Status Pembayaran:</strong> {{ internal_order_status.payment_status }}</p>
                    <p><strong>Tanggal Pesan:</strong> {{ internal_order_status.created_at }}</p>
                    {% if internal_order_status.paid_at != 'Belum Dibayar' %}
                        <p><strong>Tanggal Bayar:</strong> {{ internal_order_status.paid_at }}</p>
                    {% endif %}
                    {% if internal_order_status.shipping_info %}
                        <p class="mt-3 text-muted small"><em>{{ internal_order_status.shipping_info }}</em></p>
                    {% endif %}
                    {% if internal_order_status.awb_from_db and internal_order_status.courier_from_db %}
                        <p class="mt-3">Nomor Resi terdaftar: <strong>{{ internal_order_status.awb_from_db }}</strong> (Kurir: {{ internal_order_status.courier_from_db }}).</p>
                        {% if not tracking_result and awb_query and courier_query and request.method == 'POST' %}
                            <p class="text-warning small">Informasi pelacakan dari ekspedisi tidak ditemukan atau ada masalah saat mengambil data untuk nomor resi yang Anda masukkan.</p>
                        {% endif %}
                    {% elif awb_query and request.method == 'POST' %}
                         <p class="text-warning mt-3 small">Nomor resi belum terdaftar untuk pesanan ini di sistem kami, atau nomor resi yang Anda masukkan ({{ awb_query }}) tidak cocok dengan data kami.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            {# Hasil Pelacakan Ekspedisi #}
            {% if tracking_result %}
            <div class="card shadow-sm mt-4">
                <div class="card-header py-3" style="background-color: var(--petshop-green-primary); color: white;">
                    <h5 class="mb-0">Hasil Pelacakan Ekspedisi untuk Resi: {{ tracking_result.summary.awb if tracking_result.summary else awb_query }}</h5>
                </div>
                <div class="card-body p-4">
                    {% if tracking_result.summary %}
                    <div class="mb-4">
                        <h6>Informasi Umum</h6>
                        <dl class="row" style="font-size:0.9rem;">
                            <dt class="col-sm-4">Kurir:</dt><dd class="col-sm-8">{{ tracking_result.summary.courier_name | upper }}</dd>
                            <dt class="col-sm-4">Layanan:</dt><dd class="col-sm-8">{{ tracking_result.summary.service_code | default('N/A') }}</dd>
                            <dt class="col-sm-4">Status Terakhir:</dt><dd class="col-sm-8 fw-bold" style="color: var(--petshop-green-primary);">{{ tracking_result.summary.status | default('N/A') }}</dd>
                            <dt class="col-sm-4">Tanggal Kirim:</dt><dd class="col-sm-8">{{ tracking_result.summary.ship_date | default('N/A') }}</dd>
                            <dt class="col-sm-4">Estimasi Tiba:</dt><dd class="col-sm-8">{{ tracking_result.summary.etd | default('N/A') }}</dd>
                        </dl>
                    </div>
                    {% endif %}

                    {% if tracking_result.detail %}
                    <div class="mb-4">
                        <h6>Informasi Pengirim & Penerima</h6>
                        <div class="row" style="font-size:0.9rem;">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Pengirim:</strong></p>
                                <p class="text-muted small mb-0">
                                    {{ tracking_result.detail.shipper_name | default('N/A') }}<br>
                                    {{ tracking_result.detail.shipper_address1 | default('') }} {{ tracking_result.detail.shipper_address2 | default('') }} {{ tracking_result.detail.shipper_address3 | default('') }}<br>
                                    {{ tracking_result.detail.shipper_city | default('') }}
                                </p>
                            </div>
                            <div class="col-md-6 mt-2 mt-md-0">
                                <p class="mb-1"><strong>Penerima:</strong></p>
                                <p class="text-muted small mb-0">
                                    {{ tracking_result.detail.receiver_name | default('N/A') }}<br>
                                    {{ tracking_result.detail.receiver_address1 | default('') }} {{ tracking_result.detail.receiver_address2 | default('') }} {{ tracking_result.detail.receiver_address3 | default('') }}<br>
                                    {{ tracking_result.detail.receiver_city | default('') }}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    {% if tracking_result.manifest and tracking_result.manifest|length > 0 %}
                    <h6>Riwayat Perjalanan Paket</h6>
                    <ul class="tracking-history-list mt-3">
                        {% for item in tracking_result.manifest | reverse %}
                        <li>
                            <strong>{{ item.manifest_date }} {{ item.manifest_time }}</strong>
                            <p class="mb-0 ms-1">{{ item.manifest_description }}</p>
                            {% if item.city_name %}<small class="location ms-1">Lokasi: {{ item.city_name }}</small>{% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% elif tracking_result %} 
                    <p class="text-muted small">Tidak ada riwayat perjalanan detail yang tersedia dari ekspedisi.</p>
                    {% endif %} {# Penutup untuk if tracking_result.manifest #}
                </div>
            </div>
            {% elif error_message and request.method == 'POST' and not internal_order_status %}
             <div class="alert alert-danger mt-4" role="alert">
                {{ error_message }}
            </div>
            {% endif %} {# Penutup untuk if tracking_result atau elif error_message #}
        </div>
    </div>
</div>
{% endblock %} {# Penutup untuk block content #}

{% block scripts_page %} {# Pindahkan block scripts_page ke level yang sama dengan content #}
{{ super() if super }} 
{# Tidak ada JavaScript spesifik untuk halaman ini saat ini karena semua input wajib #}
{% endblock scripts_page %}
