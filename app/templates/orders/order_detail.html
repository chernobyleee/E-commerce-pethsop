{% extends 'base.html' %} {# Pastikan ini adalah base.html yang sudah terintegrasi dengan Famms #}

{% block title %}Detail Pesanan #{{ order.invoice_number }} - PetShopin{% endblock %}

{% block page_title %}Detail Pesanan Anda{% endblock %} {# Judul untuk inner_page_head di base.html #}

{% block head_extra %}
<style>
    .order-detail-page .card {
        margin-bottom: 1.5rem;
        border: 1px solid #e9ecef;
    }
    .order-detail-page .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        font-weight: 500;
    }
    .order-detail-page .info-label {
        font-weight: 500;
        color: #555;
        width: 150px; /* Lebar tetap untuk label agar rapi */
    }
    .order-detail-page .info-value {
        color: #333;
    }
    .order-detail-page .product-item-list .list-group-item {
        padding-left: 0;
        padding-right: 0;
        border-left: 0;
        border-right: 0;
    }
    .order-detail-page .product-item-list img {
        width: 60px;
        height: 60px;
        object-fit: contain;
        border: 1px solid #f0f0f0;
        border-radius: .25rem;
    }
    .order-detail-page .tracking-history ul {
        padding-left: 0;
        list-style-type: none;
    }
    .order-detail-page .tracking-history li {
        padding: 0.75rem 0.5rem;
        border-bottom: 1px dashed #eee;
        font-size: 0.9rem;
    }
    .order-detail-page .tracking-history li:last-child {
        border-bottom: none;
    }
    .order-detail-page .tracking-history strong {
        display: block;
        color: #333;
    }
    .order-detail-page .tracking-history small {
        color: #777;
    }
    .order-status-badge {
        font-size: 0.95rem;
        padding: .4em .7em;
    }
    .action-buttons .btn {
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .order-detail-page .action-buttons .btn, .order-detail-page .action-buttons form {
        margin-right: 0.5rem;
        margin-bottom: 0.75rem; 
    }
    /* Tambahan untuk modal */
    .modal-body textarea.form-control {
        min-height: 100px;
    }

</style>
{% endblock %}

{% block content %}
<div class="container order-detail-page py-4">
    {% include '_messages.html' %}

    <div class="row g-lg-4 g-md-3 g-3">
        <div class="col-lg-7">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header">
                    <i class="fa fa-file-text-o me-2" style="color: var(--petshop-green-primary);"></i>Informasi Pesanan
                </div>
                <div class="card-body p-4">
                    {# ... (Detail Informasi Pesanan seperti sebelumnya) ... #}
                    <dl class="row dl-horizontal mb-0">
                        <dt class="col-sm-5 col-md-4 info-label">No. Invoice:</dt>
                        <dd class="col-sm-7 col-md-8 info-value fw-bold">{{ order.invoice_number }}</dd>

                        <dt class="col-sm-5 col-md-4 info-label">Tanggal Pesan:</dt>
                        <dd class="col-sm-7 col-md-8 info-value">{{ order.created_at.strftime('%d %B %Y, %H:%M') }}</dd>

                        <dt class="col-sm-5 col-md-4 info-label">Status Pesanan:</dt>
                        <dd class="col-sm-7 col-md-8 info-value">
                            {% if order.status == 'cancellation_requested' %}
                                <span class="badge order-status-badge bg-info text-dark">Menunggu Persetujuan Pembatalan</span>
                            {% elif order.status == 'pending' or order.status == 'pending_payment' %}
                                <span class="badge order-status-badge" style="background-color: #ffc107; color: #212529;">Menunggu Pembayaran</span>
                            {# ... (status lainnya) ... #}
                            {% elif order.status == 'processing' %}
                                <span class="badge order-status-badge" style="background-color: #0dcaf0; color: #212529;">Sedang Diproses</span>
                            {% elif order.status == 'shipped' %}
                                <span class="badge order-status-badge" style="background-color: #0d6efd; color: white;">Dikirim</span>
                            {% elif order.status == 'completed' %}
                                <span class="badge order-status-badge" style="background-color: var(--petshop-green-primary); color: white;">Selesai</span>
                            {% elif order.status == 'cancelled' %}
                                <span class="badge order-status-badge bg-danger text-white">Dibatalkan</span>
                            {% elif order.status == 'failed' %}
                                <span class="badge order-status-badge bg-danger text-white">Gagal</span>
                            {% else %}
                                <span class="badge order-status-badge bg-secondary text-white">{{ order.status.replace('_',' ')|capitalize }}</span>
                            {% endif %}
                        </dd>
                        
                        <dt class="col-sm-5 col-md-4 info-label">Status Pembayaran:</dt>
                        <dd class="col-sm-7 col-md-8 info-value">
                             <span class="badge order-status-badge 
                                {% if order.payment_status == 'paid' %}bg-success text-white
                                {% elif order.payment_status == 'unpaid' %}bg-warning text-dark
                                {% elif order.payment_status == 'failed' %}bg-danger text-white
                                {% elif order.payment_status == 'refund_requested' %}bg-info text-dark
                                {% elif order.payment_status == 'refunded' %}bg-secondary text-white
                                {% else %}bg-light text-dark border
                                {% endif %}">
                                {{ order.payment_status.replace('_', ' ')|capitalize }}
                            </span>
                        </dd>
                        {# ... (tanggal lainnya) ... #}
                         {% if order.cancelled_at %}
                            <dt class="col-sm-5 col-md-4 info-label">Dibatalkan Pada:</dt>
                            <dd class="col-sm-7 col-md-8 info-value">{{ order.cancelled_at.strftime('%d %B %Y, %H:%M') }}</dd>
                             {% if order.cancellation_reason %}
                                <dt class="col-sm-5 col-md-4 info-label">Alasan Pembatalan:</dt>
                                <dd class="col-sm-7 col-md-8 info-value fst-italic">"{{ order.cancellation_reason }}"</dd>
                             {% endif %}
                             {% if order.payment_status == 'refund_requested' %}
                                <dt class="col-sm-5 col-md-4 info-label"></dt> <dd class="col-sm-7 col-md-8 info-value text-muted small mt-1 fst-italic">Admin akan menghubungi Anda untuk proses refund.</dd>
                            {% elif order.payment_status == 'refunded' %}
                                 <dt class="col-sm-5 col-md-4 info-label"></dt> <dd class="col-sm-7 col-md-8 info-value text-success small mt-1 fst-italic">Pengembalian dana telah diproses.</dd>
                            {% endif %}
                        {% elif order.cancellation_requested_at and order.status == 'cancellation_requested' %}
                            <dt class="col-sm-5 col-md-4 info-label">Pembatalan Diminta:</dt>
                            <dd class="col-sm-7 col-md-8 info-value">{{ order.cancellation_requested_at.strftime('%d %B %Y, %H:%M') }}</dd>
                            {% if order.cancellation_reason %}
                                <dt class="col-sm-5 col-md-4 info-label">Alasan:</dt>
                                <dd class="col-sm-7 col-md-8 info-value fst-italic">"{{ order.cancellation_reason }}"</dd>
                            {% endif %}
                            <dd class="col-sm-7 col-md-8 offset-sm-5 offset-md-4 text-muted small mt-1 fst-italic">Permintaan pembatalan Anda sedang ditinjau oleh Admin.</dd>
                        {% endif %}
                    </dl>
                    
                    <div class="action-buttons mt-4 pt-3 border-top">
                        {# Tombol Minta Pembatalan akan memunculkan modal #}
                        {% if order.can_request_cancellation() %} {# Gunakan metode baru dari model Order #}
                            <button type="button" class="btn btn-sm btn-outline-danger" data-toggle="modal" data-target="#cancelOrderModal">
                                <i class="fa fa-times-circle"></i> Minta Pembatalan Pesanan
                            </button>
                        {% elif order.status == 'cancellation_requested' %}
                            <p class="text-info small mb-0"><i class="fa fa-info-circle"></i> Permintaan pembatalan Anda sedang diproses.</p>
                        {% elif order.status in ['completed', 'shipped', 'cancelled'] %}
                             <p class="text-muted small mb-0"><i class="fa fa-info-circle"></i> Pesanan ini sudah {{ order.status.replace('_',' ')|lower }} dan tidak dapat dibatalkan.</p>
                        {% endif %}

                        {% if order.status == 'pending' or order.status == 'pending_payment' %}
                            <a href="{{ url_for('orders.payment', order_id=order.id) }}" class="btn btn-sm" style="background-color: var(--petshop-green-primary); border-color: var(--petshop-green-primary); color:white;">
                                <i class="fa fa-credit-card"></i> Lanjutkan Pembayaran
                            </a>
                        {% endif %}

                        {% if show_receive_button %}
                            {# ... (Tombol Produk Sudah Diterima tetap sama) ... #}
                            <form action="{{ url_for('orders.mark_as_received', order_id=order.id) }}" method="POST" class="d-inline-block">
                                <button type="submit" class="btn btn-sm" style="background-color: var(--petshop-green-primary); border-color: var(--petshop-green-primary); color:white;">
                                    <i class="fa fa-check-square-o"></i> Produk Sudah Diterima
                                </button>
                            </form>
                            <p class="text-muted mt-2 small">Setelah produk Anda terima, mohon klik tombol ini untuk menyelesaikan pesanan.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            {# ... (Card Informasi Pengiriman & Riwayat Pelacakan tetap sama) ... #}
             {% if shipment %}
            <div class="card shadow-sm border-0 mt-4">
                <div class="card-header">
                    <i class="fa fa-truck me-2" style="color: var(--petshop-green-primary);"></i>Informasi Pengiriman
                </div>
                <div class="card-body p-4">
                    <dl class="row dl-horizontal mb-0">
                        <dt class="col-sm-5 col-md-4 info-label">Penerima:</dt>
                        <dd class="col-sm-7 col-md-8 info-value">{{ shipment.name }} {% if shipment.phone %}({{ shipment.phone }}){% endif %}</dd>
                        
                        <dt class="col-sm-5 col-md-4 info-label">Alamat:</dt>
                        <dd class="col-sm-7 col-md-8 info-value">{{ shipment.address }}, {{ shipment.subdistrict if shipment.subdistrict else '' }}{{ ', ' if shipment.subdistrict and shipment.district else '' }}{{ shipment.district if shipment.district else '' }}{{ ', ' if shipment.district and shipment.city else '' }}{{ shipment.city if shipment.city else '' }}{{ ', ' if shipment.city and shipment.province else '' }}{{ shipment.province if shipment.province else '' }}{{ ' ' + shipment.zip_code if shipment.zip_code else '' }}</dd>
                        
                        <dt class="col-sm-5 col-md-4 info-label">Kurir:</dt>
                        <dd class="col-sm-7 col-md-8 info-value">{{ shipment.courier | upper if shipment.courier else '' }} - {{ shipment.service if shipment.service else '' }}</dd>
                        
                        <dt class="col-sm-5 col-md-4 info-label">Estimasi Tiba:</dt>
                        <dd class="col-sm-7 col-md-8 info-value">{{ shipment.estimate if shipment.estimate else '-' }}</dd>
                         <dt class="col-sm-5 col-md-4 info-label">Biaya Pengiriman:</dt>
                        <dd class="col-sm-7 col-md-8 info-value">Rp {{ "{:,.0f}".format(shipment.cost if shipment.cost is not none else 0) }}</dd>
                        
                        <dt class="col-sm-5 col-md-4 info-label">Nomor Resi:</dt>
                        <dd class="col-sm-7 col-md-8 info-value">
                            {% if shipment.tracking_number %}
                                <strong style="color: var(--petshop-green-primary);">{{ shipment.tracking_number }}</strong>
                            {% else %}
                                <span class="text-muted fst-italic">Belum tersedia</span>
                            {% endif %}
                        </dd>
                    </dl>
                </div>
            </div>
            {% endif %}
            
            {% if shipment and shipment.tracking_number %}
            {# ... (Card Riwayat Pelacakan tetap sama) ... #}
            <div class="card shadow-sm border-0 mt-4 tracking-history">
                <div class="card-header">
                     <i class="fa fa-map-signs me-2" style="color: var(--petshop-green-primary);"></i>Riwayat Pelacakan
                </div>
                <div class="card-body p-3">
                    {% if tracking_error %}
                        <div class="alert alert-warning small py-2" role="alert">
                            <i class="fa fa-exclamation-triangle me-1"></i> Gagal memuat riwayat pelacakan: {{ tracking_error }}
                        </div>
                    {% elif tracking_history and tracking_history.manifest and tracking_history.manifest|length > 0 %}
                        <ul class="tracking-history-list">
                            {% for item in tracking_history.manifest | reverse %} {# Tampilkan dari terbaru #}
                            <li>
                                <strong>{{ item.manifest_date }} {{ item.manifest_time }}</strong>
                                <p class="mb-0 ms-1">{{ item.manifest_description }}</p>
                                {% if item.city_name %}<small class="location ms-1">Lokasi: {{ item.city_name }}</small>{% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="alert alert-info small py-2" role="alert">
                            Nomor resi belum bisa dilacak saat ini atau tidak ada riwayat dari ekspedisi. Silakan coba beberapa saat lagi.
                        </div>
                    {% endif %}
                </div>
            </div>
            {% elif order.status == 'shipped' and not (shipment and shipment.tracking_number) %}
             <div class="card shadow-sm border-0 mt-4">
                <div class="card-header">
                    <i class="fa fa-map-signs me-2" style="color: var(--petshop-green-primary);"></i>Riwayat Pelacakan
                </div>
                <div class="card-body p-3">
                     <p class="text-muted small m-0">Nomor resi belum diinput oleh admin.</p>
                </div>
            </div>
            {% endif %}
        </div>

        {# Kolom Kanan: Detail Produk Dipesan & Total #}
        <div class="col-lg-5">
            {# ... (Card Detail Produk Dipesan tetap sama) ... #}
             <div class="card shadow-sm border-0">
                <div class="card-header">
                    <i class="fa fa-shopping-basket me-2" style="color: var(--petshop-green-primary);"></i>Produk Dipesan
                </div>
                <div class="card-body p-0"> 
                    <div class="table-responsive">
                        <table class="table table-items mb-0">
                            <tbody>
                                {% for detail in order_details %}
                                <tr style="border-bottom: 1px solid #f1f1f1;">
                                    <td class="py-3 ps-3">
                                        <div class="d-flex align-items-center">
                                            <img src="{{ detail.product.image_url if detail.product.image_url else url_for('static', filename='famms_template/images/p1.png') }}" alt="{{ detail.product.name }}" class="mr-2" height="50" width="50">
                                            <div>
                                                <a href="{{ url_for('products.product_detail', product_id=detail.product.id) }}" class="text-dark" style="font-weight: 500; font-size:0.9rem; text-decoration:none;">{{ detail.product.name }}</a>
                                                <small class="d-block text-muted">{{ detail.quantity }} x Rp {{ '{:,.0f}'.format(detail.price) }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="text-end align-middle fw-bold pe-3" style="font-size: 0.9rem;">
                                        Rp {{ '{:,.0f}'.format(detail.quantity * detail.price) }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-white p-3">
                    <ul class="list-group list-group-flush" style="font-size: 0.95rem;">
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-1">
                            <span>Subtotal Barang:</span>
                            <span class="fw-bold">Rp {{ '{:,.0f}'.format(subtotal) }}</span> 
                        </li>
                        {% if shipment and shipment.cost is not none %}
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 py-1">
                            <span>Biaya Pengiriman:</span>
                            <span class="fw-bold">Rp {{ '{:,.0f}'.format(shipment.cost) }}</span>
                        </li>
                        {% endif %}
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0 pt-2 mt-2 border-top h5 mb-0">
                            <strong>Total Pesanan:</strong>
                            <strong class="total-summary-value">Rp {{ '{:,.0f}'.format(order.total) }}</strong>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4 pt-3 border-top text-center">
        <a href="{{ url_for('orders.order_list') }}" class="btn btn-outline-secondary btn-back-list">
            <i class="fa fa-list"></i> Kembali ke Daftar Pesanan Saya
        </a>
    </div>

    {# Modal untuk Alasan Pembatalan #}
    {% if order.can_request_cancellation() and cancellation_form %} {# Pastikan cancellation_form dikirim dari route #}
    <div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form method="POST" action="{{ url_for('orders.request_cancellation', order_id=order.id) }}">
                    {{ cancellation_form.hidden_tag() }}
                    <div class="modal-header">
                        <h5 class="modal-title" id="cancelOrderModalLabel">Formulir Permintaan Pembatalan Pesanan</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <p>Pesanan: <strong>#{{ order.invoice_number }}</strong></p>
                        <p>Mohon berikan alasan mengapa Anda ingin membatalkan pesanan ini:</p>
                        {{ cancellation_form.reason.label(class="form-label") }}
                        {{ cancellation_form.reason(class="form-control" + (" is-invalid" if cancellation_form.reason.errors else "")) }}
                        {% if cancellation_form.reason.errors %}
                            <div class="invalid-feedback">
                                {% for error in cancellation_form.reason.errors %}<span>{{ error }}</span>{% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Tutup</button>
                        {{ cancellation_form.submit(class="btn btn-danger") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block scripts_page %}
{# Tidak ada JS spesifik untuk halaman ini saat ini, kecuali jika Anda ingin auto-refresh tracking atau JS untuk modal jika diperlukan #}
{% endblock %}
